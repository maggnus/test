WebApp on Apache Mesos
======================
Deploy simple webapp with upload functionality on Docker and Apache Mesos.

Prerequisites
--------------------------
1. Install [VirtualBox](https://www.virtualbox.org/wiki/Downloads) for setup virtual environment.
1. Install [Vagrant](https://www.vagrantup.com/downloads.html) tool for deploy virtual servers.
2. Install [Ansible](http://docs.ansible.com/ansible/intro_installation.html) for configure system.

Install virtual servers
--------------------------
Clone project repository:
```console
git clone https://github.com/maggnus/marathon_cluster_vagrant.git
cd marathon_cluster_vagrant
```
Check configuration file `etc/cluster_config.yml`:
```yaml
---
box_name: "ubuntu/trusty64"

providers:
  # VirtualBox
  virtualbox:
    enable: true
  # Amazone EC2 (not implemented)
  ec2:
    enable: false
    access_key_id:  EDIT_HERE
    secret_access_key: EDIT_HERE
    region: us-east-1
    security_groups: EDIT_HERE
    instance_type: m1.small
    keypair_name: EDIT_HERE
    ssh_private_key_path: EDIT_HERE

servers:
  ## Master hosts
  - name: "master-1"
    box: "ubuntu/trusty64"
    cpu: 1
    ram: 512
    ip: 172.17.8.101
    role: "master"
    zk_id: 1

  - name: "master-2"
    box: "ubuntu/trusty64"
    cpu: 1
    ram: 512
    ip: 172.17.8.102
    role: "master"
    zk_id: 2

  ## Slave hosts
  - name: "slave-1"
    box: "ubuntu/trusty64"
    cpu: 2
    ram: 2048
    ip: 172.17.8.201
    role: "slave"
```
Deploy virtual servers with `Vagrantfile`:
```console
vagrant up
```
or apply changes
```console
vagrant reload --provision
```
After setting up virtual server Vagrant apply Ansible script with name based on the server role `master` or `slave`.
It also create dynamic inventory file in current folder `.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory`.

![Virtualbox](https://raw.githubusercontent.com/maggnus/marathon_cluster_vagrant/master/doc/images/01_virtualbox.png)

```
# Generated by Vagrant

master-1 ansible_ssh_host=127.0.0.1 ansible_ssh_port=2222 ansible_ssh_user='vagrant' ansible_ssh_private_key_file='/Users/maggnus/Develop/docup/02_Setup/02_vagrant/.vagrant/m
achines/master-1/virtualbox/private_key' instance_name=master-1 instance_box=ubuntu/trusty64 instance_cpu=1 instance_ram=512 instance_ip=172.17.8.101 instance_role=master ins
tance_zk_id=1
master-2 ansible_ssh_host=127.0.0.1 ansible_ssh_port=2200 ansible_ssh_user='vagrant' ansible_ssh_private_key_file='/Users/maggnus/Develop/docup/02_Setup/02_vagrant/.vagrant/m
achines/master-2/virtualbox/private_key' instance_name=master-2 instance_box=ubuntu/trusty64 instance_cpu=1 instance_ram=512 instance_ip=172.17.8.102 instance_role=master ins
tance_zk_id=2
slave-1 ansible_ssh_host=127.0.0.1 ansible_ssh_port=2201 ansible_ssh_user='vagrant' ansible_ssh_private_key_file='/Users/maggnus/Develop/docup/02_Setup/02_vagrant/.vagrant/ma
chines/slave-1/virtualbox/private_key' instance_name=slave-1 instance_box=ubuntu/trusty64 instance_cpu=2 instance_ram=2048 instance_ip=172.17.8.201 instance_role=slave

[master]
master-1
master-2

[slave]
slave-1
```

Create simple WebApp container
--------------------------
WebApp it's simple Noje.js application which can store upload files to particular folder.
The source files can be found in `webapp` folder.

![WebApp](https://raw.githubusercontent.com/maggnus/marathon_cluster_vagrant/master/doc/images/02_webapp.png)

You can pull prepered image form Docker Hub:
```console
docker pull maggnus/webapp
```
Build docker container (OPTIONAL):
```
docker build -t maggnus/webapp webapp/
```
Run container in interactive mode for testing application:
```console
docker run -it --rm -p 3000:3000 -v /opt/upload:/usr/src/app/public/upload --name webapp maggnus/webapp
```
`/opt/upload` - host folder for uploaded files, `/usr/src/app/public/upload` - container folder

Start WebApp in Mesos cluster
--------------------------
Open Maraphon web UI with one of the master servers.
```
http://master-1:8080/
http://master-2:8080/
```
![Maraphon](https://raw.githubusercontent.com/maggnus/marathon_cluster_vagrant/master/doc/images/03_maraphon.png)

Deploy WebApp application with Docker image `maggnus/webapp`:
```json
{
  "id": "webapp",
  "cmd": null,
  "cpus": 1,
  "mem": 256,
  "disk": 0,
  "instances": 1,
  "container": {
    "docker": {
      "image": "maggnus/webapp",
      "network": "BRIDGE",
      "privileged": false,
      "portMappings": [
        {
          "containerPort": 0,
          "protocol": "tcp",
          "name": null,
          "labels": null
        }
      ]
    },
    "type": "DOCKER",
    "volumes": [
      {
        "hostPath": "/opt/upload",
        "containerPath": "/usr/src/app/public/upload",
        "mode": "RW"
      }
    ]
  },
  "env": {}
}
```
Open WebApp with assigned port.

![Open WebApp](https://raw.githubusercontent.com/maggnus/marathon_cluster_vagrant/master/doc/images/04_port.png)
